# MySQL锁

MySQL不同的存储引擎支持不同的锁机制。InnoDB支持行锁，有时会升级为表锁；MyISAM只支持表锁。

- 表锁的特点是开销小、加锁快；不会出现死锁；锁粒度大，发生锁冲突的概率高，并发度相对较低。
- 行锁的特点是开销大、加锁慢；会出现死锁；锁粒度小，发生锁冲突的概率低，并发度也相对表锁高。

## 一. InnoDB锁类型

InnoDB的行锁类型主要包括：读锁、写锁、意向锁和MDL锁。

### 1.1 读锁（共享锁）

读锁，简称为S锁（Share），一个事务获取了一个数据行的读锁，其他事务能获得该行对应的读锁，但是不能获得写锁，即一个事务在读取一个数据行时，其他事务也可以读，但是不能对数据行进行增删改操作。

读锁有两种select方式的应用，第一种是自动提交模式下的select查询语句，不需要加任何锁，直接返回查询结果，这就是一致性非锁定读。第二种就是通过 select .... lock in share mode 在被读取的行记录或行记录的范围上加一个读锁。让其他事务可以读，但是要想申请加写锁，那就会被阻塞。

### 1.2 写锁（排它锁）

写锁，简称X锁，一个事务获取了一个数据行的写锁，其他事务就不能再获取该行的其他锁，写锁优先级最高。

写锁的应用比较简单，一些DML语句的操作都会对行记录加写锁。

比较特殊的就是select for update，它会对读取的行记录上加上一个写锁，那么其他任何事务就不能对被锁的行上加任何锁了，要不然会被阻塞。

## 1.3 MDL锁

MySQL 5.5引入了 meta data lock，简称MDL锁，用于保证表中元数据的信息。在会话A中，表开启了查询事务后，会自动获取一个MDL锁，会话B就不会执行任何DDL语句的操作。

不能执行为表中添加字段的操作，会用MDL锁老保护数据之间的一致性。

![](../images/24.gif)

### 1.4 意向锁

在MySQL存储引擎InnoDB中，意向锁时表级锁。而且有两种意向锁的类型，分别为意向共享锁和意向排他锁。

- 意向共享锁（IS）是指在给一个数据行加共享锁前必须取得该表的IS锁。
- 意向排他锁（IX）是指在给一个数据行加排它锁前必须先取得该表的IX锁。

其实意向锁的作用跟MDL类似，都是为了防止在事务进行的过程中，执行DDL语句的操作而致数据的不一致。

## 二. InnoDB行锁的种类

InnoDB在默认情况下事务隔离级别为RR



